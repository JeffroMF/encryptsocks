'use strict';

exports.__esModule = true;
exports.usernamePasswordAuthetication = usernamePasswordAuthetication;
exports.startServer = startServer;

var _ip = require('ip');

var _ip2 = _interopRequireDefault(_ip);

var _net = require('net');

var _utils = require('./utils');

var _logger = require('./logger');

var _encryptor = require('./encryptor');

var _pacServer = require('./pacServer');

var _createUDPRelay = require('./createUDPRelay');

var _createUDPRelay2 = _interopRequireDefault(_createUDPRelay);

var _auth = require('./auth');

var _config = require('./config');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var NAME = 'ss_local';

var logger = void 0;

function handleMethod(connection, data, authInfo) {
  // +----+----------+----------+
  // |VER | NMETHODS | METHODS  |
  // +----+----------+----------+
  // | 1  |    1     | 1 to 255 |
  // +----+----------+----------+
  var forceAuth = authInfo.forceAuth;

  var buf = new Buffer(2);

  var method = -1;

  if (forceAuth && data.indexOf(0x02, 2) >= 0) {
    method = 2;
  }

  if (!forceAuth && data.indexOf(0x00, 2) >= 0) {
    method = 0;
  }

  // allow `no authetication` or any usename/password
  if (method === -1) {
    // logger.warn(`unsupported method: ${data.toString('hex')}`);
    buf.writeUInt16BE(0x05FF);
    connection.write(buf);
    connection.end();
    return -1;
  }

  buf.writeUInt16BE(0x0500);
  connection.write(buf);

  return method === 0 ? 1 : 3;
}

function fetchUsernamePassword(data) {
  // suppose all VER is 0x01
  if (!(data instanceof Buffer)) {
    return null;
  }

  var ulen = data[1];
  var username = data.slice(2, ulen + 2).toString('ascii');
  var plenStart = ulen + 2;
  var plen = data[plenStart];
  var password = data.slice(plenStart + 1, plenStart + 1 + plen).toString('ascii');

  return { username: username, password: password };
}

function responseAuth(success, connection) {
  var buf = new Buffer(2);
  var toWrite = success ? 0x0100 : 0x0101;
  var nextProcedure = success ? 2 : -1;

  buf.writeUInt16BE(toWrite);
  connection.write(buf);
  connection.end();

  return nextProcedure;
}

function usernamePasswordAuthetication(connection, data, authInfo) {
  // +----+------+----------+------+----------+
  // |VER | ULEN |  UNAME   | PLEN |  PASSWD  |
  // +----+------+----------+------+----------+
  // | 1  |  1   | 1 to 255 |  1   | 1 to 255 |
  // +----+------+----------+------+----------+

  var usernamePassword = fetchUsernamePassword(data);

  if (!usernamePassword) {
    return responseAuth(false, connection);
  }

  var username = usernamePassword.username,
      password = usernamePassword.password;


  if (!(0, _auth.validate)(authInfo, username, password)) {
    return responseAuth(false, connection);
  }

  return responseAuth(true, connection);
}

function handleRequest(connection, data, _ref, dstInfo, onConnect, onDestroy, isClientConnected) {
  var serverAddr = _ref.serverAddr,
      serverPort = _ref.serverPort,
      password = _ref.password,
      method = _ref.method,
      localAddr = _ref.localAddr,
      localPort = _ref.localPort,
      localAddrIPv6 = _ref.localAddrIPv6;

  var cmd = data[1];
  var clientOptions = {
    port: serverPort,
    host: serverAddr
  };
  var isUDPRelay = cmd === 0x03;

  var repBuf = void 0;
  var tmp = null;
  var decipher = null;
  var decipheredData = null;
  var cipher = null;
  var cipheredData = null;

  if (cmd !== 0x01 && !isUDPRelay) {
    logger.warn('unsupported cmd: ' + cmd);
    return {
      stage: -1
    };
  }

  // prepare data

  // +----+-----+-------+------+----------+----------+
  // |VER | REP |  RSV  | ATYP | BND.ADDR | BND.PORT |
  // +----+-----+-------+------+----------+----------+
  // | 1  |  1  | X'00' |  1   | Variable |    2     |
  // +----+-----+-------+------+----------+----------+

  if (isUDPRelay) {
    var isUDP4 = dstInfo.atyp === 1;

    repBuf = new Buffer(4);
    repBuf.writeUInt32BE(isUDP4 ? 0x05000001 : 0x05000004);
    tmp = new Buffer(2);
    tmp.writeUInt16BE(localPort);
    repBuf = Buffer.concat([repBuf, _ip2.default.toBuffer(isUDP4 ? localAddr : localAddrIPv6), tmp]);

    connection.write(repBuf);

    return {
      stage: -1
    };
  }

  logger.verbose('connecting: ' + dstInfo.dstAddr.toString('utf8') + (':' + dstInfo.dstPort.readUInt16BE()));

  repBuf = new Buffer(10);
  repBuf.writeUInt32BE(0x05000001);
  repBuf.writeUInt32BE(0x00000000, 4, 4);
  repBuf.writeUInt16BE(0, 8, 2);

  tmp = (0, _encryptor.createCipher)(password, method, data.slice(3)); // skip VER, CMD, RSV
  cipher = tmp.cipher;
  cipheredData = tmp.data;

  // connect
  var clientToRemote = (0, _net.connect)(clientOptions, function () {
    onConnect();
  });

  clientToRemote.on('data', function (remoteData) {
    if (!decipher) {
      tmp = (0, _encryptor.createDecipher)(password, method, remoteData);
      if (!tmp) {
        logger.warn(NAME + ' get invalid msg');
        onDestroy();
        return;
      }
      decipher = tmp.decipher;
      decipheredData = tmp.data;
    } else {
      decipheredData = decipher.update(remoteData);
    }

    if (isClientConnected()) {
      (0, _utils.writeOrPause)(clientToRemote, connection, decipheredData);
    } else {
      clientToRemote.destroy();
    }
  });

  clientToRemote.on('drain', function () {
    connection.resume();
  });

  clientToRemote.on('end', function () {
    connection.end();
  });

  clientToRemote.on('error', function (e) {
    logger.warn('ssLocal error happened in clientToRemote when' + (' connecting to ' + (0, _utils.getDstStr)(dstInfo) + ': ' + e.message));

    onDestroy();
  });

  clientToRemote.on('close', function (e) {
    if (e) {
      connection.destroy();
    } else {
      connection.end();
    }
  });

  // write
  connection.write(repBuf);

  (0, _utils.writeOrPause)(connection, clientToRemote, cipheredData);

  return {
    stage: 2,
    cipher: cipher,
    clientToRemote: clientToRemote
  };
}

function handleConnection(config, connection) {
  var authInfo = config.authInfo;


  var stage = 0;
  var clientToRemote = void 0;
  var tmp = void 0;
  var cipher = void 0;
  var dstInfo = void 0;
  var remoteConnected = false;
  var clientConnected = true;
  var timer = null;

  connection.on('data', function (data) {
    switch (stage) {
      case 0:
        stage = handleMethod(connection, data, authInfo);

        break;
      case 1:
        dstInfo = (0, _utils.getDstInfo)(data);

        if (!dstInfo) {
          logger.warn('Failed to get \'dstInfo\' from parsing data: ' + data);
          connection.destroy();
          return;
        }

        tmp = handleRequest(connection, data, config, dstInfo, function () {
          // after connected
          remoteConnected = true;
        }, function () {
          // get invalid msg or err happened
          if (remoteConnected) {
            remoteConnected = false;
            clientToRemote.destroy();
          }

          if (clientConnected) {
            clientConnected = false;
            connection.destroy();
          }
        }, function () {
          return clientConnected;
        });

        stage = tmp.stage;

        if (stage === 2) {
          clientToRemote = tmp.clientToRemote;
          cipher = tmp.cipher;
        } else {
          // udp relay
          clientConnected = false;
          connection.end();
        }

        break;
      case 2:
        tmp = cipher.update(data);

        (0, _utils.writeOrPause)(connection, clientToRemote, tmp);

        break;
      case 3:
        // rfc 1929 username/password authetication
        stage = usernamePasswordAuthetication(connection, data, authInfo);
        break;
      default:
    }
  });

  connection.on('drain', function () {
    if (remoteConnected) {
      clientToRemote.resume();
    }
  });

  connection.on('end', function () {
    clientConnected = false;
    if (remoteConnected) {
      clientToRemote.end();
    }
  });

  connection.on('close', function (e) {
    if (timer) {
      clearTimeout(timer);
    }

    clientConnected = false;

    if (remoteConnected) {
      if (e) {
        clientToRemote.destroy();
      } else {
        clientToRemote.end();
      }
    }
  });

  connection.on('error', function (e) {
    logger.warn(NAME + ' error happened in client connection: ' + e.message);
  });

  timer = setTimeout(function () {
    if (clientConnected) {
      connection.destroy();
    }

    if (remoteConnected) {
      clientToRemote.destroy();
    }
  }, config.timeout * 1000);
}

function closeAll() {
  (0, _utils.closeSilently)(this.server);
  (0, _utils.closeSilently)(this.pacServer);

  this.udpRelay.close();

  if (this.httpProxyServer) {
    this.httpProxyServer.close();
  }
}

function createServer(config) {
  var server = (0, _net.createServer)(handleConnection.bind(null, config));
  var udpRelay = (0, _createUDPRelay2.default)(config, false, logger);
  var pacServer = (0, _pacServer.createPACServer)(config, logger);

  server.on('close', function () {
    logger.warn(NAME + ' server closed');
  });

  server.on('error', function (e) {
    logger.error(NAME + ' server error: ' + e.message);
  });

  server.listen(config.localPort);

  logger.verbose(NAME + ' is listening on ' + config.localAddr + ':' + config.localPort);

  return {
    server: server,
    udpRelay: udpRelay,
    pacServer: pacServer,
    closeAll: closeAll
  };
}

// eslint-disable-next-line
function startServer(config) {
  var willLogToConsole = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;

  logger = logger || (0, _logger.createLogger)(config, _logger.LOG_NAMES.LOCAL, willLogToConsole);

  var _createAuthInfo = (0, _auth.createAuthInfo)(config),
      info = _createAuthInfo.info,
      warn = _createAuthInfo.warn,
      error = _createAuthInfo.error;

  if (error) {
    logger.error(NAME + ' error: ' + error);
    return null;
  }

  if (warn) {
    logger.warn(NAME + ': ' + warn);
  }

  return createServer(Object.assign({}, config, {
    authInfo: info
  }));
}

if (module === require.main) {
  (0, _config.getConfig)(process.argv.slice(2), function (err, config) {
    if (err) {
      throw err;
    }

    var proxyOptions = config.proxyOptions;


    logger = (0, _logger.createLogger)(proxyOptions, _logger.LOG_NAMES.LOCAL, true, true);
    startServer(proxyOptions, false);
  });

  process.on('uncaughtException', function (err) {
    logger.error(NAME + ' uncaughtException: ' + err.stack + ' ', (0, _utils.createSafeAfterHandler)(logger, function () {
      process.exit(1);
    }));
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zc0xvY2FsLmpzIl0sIm5hbWVzIjpbInVzZXJuYW1lUGFzc3dvcmRBdXRoZXRpY2F0aW9uIiwic3RhcnRTZXJ2ZXIiLCJOQU1FIiwibG9nZ2VyIiwiaGFuZGxlTWV0aG9kIiwiY29ubmVjdGlvbiIsImRhdGEiLCJhdXRoSW5mbyIsImZvcmNlQXV0aCIsImJ1ZiIsIkJ1ZmZlciIsIm1ldGhvZCIsImluZGV4T2YiLCJ3cml0ZVVJbnQxNkJFIiwid3JpdGUiLCJlbmQiLCJmZXRjaFVzZXJuYW1lUGFzc3dvcmQiLCJ1bGVuIiwidXNlcm5hbWUiLCJzbGljZSIsInRvU3RyaW5nIiwicGxlblN0YXJ0IiwicGxlbiIsInBhc3N3b3JkIiwicmVzcG9uc2VBdXRoIiwic3VjY2VzcyIsInRvV3JpdGUiLCJuZXh0UHJvY2VkdXJlIiwidXNlcm5hbWVQYXNzd29yZCIsImhhbmRsZVJlcXVlc3QiLCJkc3RJbmZvIiwib25Db25uZWN0Iiwib25EZXN0cm95IiwiaXNDbGllbnRDb25uZWN0ZWQiLCJzZXJ2ZXJBZGRyIiwic2VydmVyUG9ydCIsImxvY2FsQWRkciIsImxvY2FsUG9ydCIsImxvY2FsQWRkcklQdjYiLCJjbWQiLCJjbGllbnRPcHRpb25zIiwicG9ydCIsImhvc3QiLCJpc1VEUFJlbGF5IiwicmVwQnVmIiwidG1wIiwiZGVjaXBoZXIiLCJkZWNpcGhlcmVkRGF0YSIsImNpcGhlciIsImNpcGhlcmVkRGF0YSIsIndhcm4iLCJzdGFnZSIsImlzVURQNCIsImF0eXAiLCJ3cml0ZVVJbnQzMkJFIiwiY29uY2F0IiwidG9CdWZmZXIiLCJ2ZXJib3NlIiwiZHN0QWRkciIsImRzdFBvcnQiLCJyZWFkVUludDE2QkUiLCJjbGllbnRUb1JlbW90ZSIsIm9uIiwicmVtb3RlRGF0YSIsInVwZGF0ZSIsImRlc3Ryb3kiLCJyZXN1bWUiLCJlIiwibWVzc2FnZSIsImhhbmRsZUNvbm5lY3Rpb24iLCJjb25maWciLCJyZW1vdGVDb25uZWN0ZWQiLCJjbGllbnRDb25uZWN0ZWQiLCJ0aW1lciIsImNsZWFyVGltZW91dCIsInNldFRpbWVvdXQiLCJ0aW1lb3V0IiwiY2xvc2VBbGwiLCJzZXJ2ZXIiLCJwYWNTZXJ2ZXIiLCJ1ZHBSZWxheSIsImNsb3NlIiwiaHR0cFByb3h5U2VydmVyIiwiY3JlYXRlU2VydmVyIiwiYmluZCIsImVycm9yIiwibGlzdGVuIiwid2lsbExvZ1RvQ29uc29sZSIsIkxPQ0FMIiwiaW5mbyIsIk9iamVjdCIsImFzc2lnbiIsIm1vZHVsZSIsInJlcXVpcmUiLCJtYWluIiwicHJvY2VzcyIsImFyZ3YiLCJlcnIiLCJwcm94eU9wdGlvbnMiLCJzdGFjayIsImV4aXQiXSwibWFwcGluZ3MiOiI7OztRQTRFZ0JBLDZCLEdBQUFBLDZCO1FBOFNBQyxXLEdBQUFBLFc7O0FBMVhoQjs7OztBQUNBOztBQUNBOztBQUVBOztBQUNBOztBQUNBOztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFFQSxJQUFNQyxPQUFPLFVBQWI7O0FBRUEsSUFBSUMsZUFBSjs7QUFFQSxTQUFTQyxZQUFULENBQXNCQyxVQUF0QixFQUFrQ0MsSUFBbEMsRUFBd0NDLFFBQXhDLEVBQWtEO0FBQ2hEO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFMZ0QsTUFNeENDLFNBTndDLEdBTTFCRCxRQU4wQixDQU14Q0MsU0FOd0M7O0FBT2hELE1BQU1DLE1BQU0sSUFBSUMsTUFBSixDQUFXLENBQVgsQ0FBWjs7QUFFQSxNQUFJQyxTQUFTLENBQUMsQ0FBZDs7QUFFQSxNQUFJSCxhQUFhRixLQUFLTSxPQUFMLENBQWEsSUFBYixFQUFtQixDQUFuQixLQUF5QixDQUExQyxFQUE2QztBQUMzQ0QsYUFBUyxDQUFUO0FBQ0Q7O0FBRUQsTUFBSSxDQUFDSCxTQUFELElBQWNGLEtBQUtNLE9BQUwsQ0FBYSxJQUFiLEVBQW1CLENBQW5CLEtBQXlCLENBQTNDLEVBQThDO0FBQzVDRCxhQUFTLENBQVQ7QUFDRDs7QUFFRDtBQUNBLE1BQUlBLFdBQVcsQ0FBQyxDQUFoQixFQUFtQjtBQUNqQjtBQUNBRixRQUFJSSxhQUFK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d0JnRCxJQUF4QjtBQUNEOztBQUVELFNBQU9pQyxhQUFhTyxPQUFPQyxNQUFQLENBQWMsRUFBZCxFQUFrQnJCLE1BQWxCLEVBQTBCO0FBQzVDL0QsY0FBVWtGO0FBRGtDLEdBQTFCLENBQWIsQ0FBUDtBQUdEOztBQUVELElBQUlHLFdBQVdDLFFBQVFDLElBQXZCLEVBQTZCO0FBQzNCLHlCQUFVQyxRQUFRQyxJQUFSLENBQWE3RSxLQUFiLENBQW1CLENBQW5CLENBQVYsRUFBaUMsVUFBQzhFLEdBQUQsRUFBTTNCLE1BQU4sRUFBaUI7QUFDaEQsUUFBSTJCLEdBQUosRUFBUztBQUNQLFlBQU1BLEdBQU47QUFDRDs7QUFIK0MsUUFLeENDLFlBTHdDLEdBS3ZCNUIsTUFMdUIsQ0FLeEM0QixZQUx3Qzs7O0FBT2hEL0YsYUFBUywwQkFDUCtGLFlBRE8sRUFFUCxrQkFBVVYsS0FGSCxFQUdQLElBSE8sRUFJUCxJQUpPLENBQVQ7QUFNQXZGLGdCQUFZaUcsWUFBWixFQUEwQixLQUExQjtBQUNELEdBZEQ7O0FBZ0JBSCxVQUFRakMsRUFBUixDQUFXLG1CQUFYLEVBQWdDLFVBQUNtQyxHQUFELEVBQVM7QUFDdkM5RixXQUFPa0YsS0FBUCxDQUFnQm5GLElBQWhCLDRCQUEyQytGLElBQUlFLEtBQS9DLFFBQXlELG1DQUF1QmhHLE1BQXZCLEVBQStCLFlBQU07QUFDNUY0RixjQUFRSyxJQUFSLENBQWEsQ0FBYjtBQUNELEtBRndELENBQXpEO0FBR0QsR0FKRDtBQUtEIiwiZmlsZSI6InNzTG9jYWwuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgaXAgZnJvbSAnaXAnO1xuaW1wb3J0IHsgY3JlYXRlU2VydmVyIGFzIF9jcmVhdGVTZXJ2ZXIsIGNvbm5lY3QgfSBmcm9tICduZXQnO1xuaW1wb3J0IHsgZ2V0RHN0SW5mbywgd3JpdGVPclBhdXNlLCBnZXREc3RTdHIsIGNsb3NlU2lsZW50bHksXG4gIGNyZWF0ZVNhZmVBZnRlckhhbmRsZXIgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IGNyZWF0ZUxvZ2dlciwgTE9HX05BTUVTIH0gZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgY3JlYXRlQ2lwaGVyLCBjcmVhdGVEZWNpcGhlciB9IGZyb20gJy4vZW5jcnlwdG9yJztcbmltcG9ydCB7IGNyZWF0ZVBBQ1NlcnZlciB9IGZyb20gJy4vcGFjU2VydmVyJztcbmltcG9ydCBjcmVhdGVVRFBSZWxheSBmcm9tICcuL2NyZWF0ZVVEUFJlbGF5JztcbmltcG9ydCB7IGNyZWF0ZUF1dGhJbmZvLCB2YWxpZGF0ZSB9IGZyb20gJy4vYXV0aCc7XG5pbXBvcnQgeyBnZXRDb25maWcgfSBmcm9tICcuL2NvbmZpZyc7XG5cbmNvbnN0IE5BTUUgPSAnc3NfbG9jYWwnO1xuXG5sZXQgbG9nZ2VyO1xuXG5mdW5jdGlvbiBoYW5kbGVNZXRob2QoY29ubmVjdGlvbiwgZGF0YSwgYXV0aEluZm8pIHtcbiAgLy8gKy0tLS0rLS0tLS0tLS0tLSstLS0tLS0tLS0tK1xuICAvLyB8VkVSIHwgTk1FVEhPRFMgfCBNRVRIT0RTICB8XG4gIC8vICstLS0tKy0tLS0tLS0tLS0rLS0tLS0tLS0tLStcbiAgLy8gfCAxICB8ICAgIDEgICAgIHwgMSB0byAyNTUgfFxuICAvLyArLS0tLSstLS0tLS0tLS0tKy0tLS0tLS0tLS0rXG4gIGNvbnN0IHsgZm9yY2VBdXRoIH0gPSBhdXRoSW5mbztcbiAgY29uc3QgYnVmID0gbmV3IEJ1ZmZlcigyKTtcblxuICBsZXQgbWV0aG9kID0gLTE7XG5cbiAgaWYgKGZvcmNlQXV0aCAmJiBkYXRhLmluZGV4T2YoMHgwMiwgMikgPj0gMCkge1xuICAgIG1ldGhvZCA9IDI7XG4gIH1cblxuICBpZiAoIWZvcmNlQXV0aCAmJiBkYXRhLmluZGV4T2YoMHgwMCwgMikgPj0gMCkge1xuICAgIG1ldGhvZCA9IDA7XG4gIH1cblxuICAvLyBhbGxvdyBgbm8gYXV0aGV0aWNhdGlvbmAgb3IgYW55IHVzZW5hbWUvcGFzc3dvcmRcbiAgaWYgKG1ldGhvZCA9PT0gLTEpIHtcbiAgICAvLyBsb2dnZXIud2FybihgdW5zdXBwb3J0ZWQgbWV0aG9kOiAke2RhdGEudG9TdHJpbmcoJ2hleCcpfWApO1xuICAgIGJ1Zi53cml0ZVVJbnQxNkJFKDB4MDVGRik7XG4gICAgY29ubmVjdGlvbi53cml0ZShidWYpO1xuICAgIGNvbm5lY3Rpb24uZW5kKCk7XG4gICAgcmV0dXJuIC0xO1xuICB9XG5cbiAgYnVmLndyaXRlVUludDE2QkUoMHgwNTAwKTtcbiAgY29ubmVjdGlvbi53cml0ZShidWYpO1xuXG4gIHJldHVybiBtZXRob2QgPT09IDAgPyAxIDogMztcbn1cblxuZnVuY3Rpb24gZmV0Y2hVc2VybmFtZVBhc3N3b3JkKGRhdGEpIHtcbiAgLy8gc3VwcG9zZSBhbGwgVkVSIGlzIDB4MDFcbiAgaWYgKCEoZGF0YSBpbnN0YW5jZW9mIEJ1ZmZlcikpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHVsZW4gPSBkYXRhWzFdO1xuICBjb25zdCB1c2VybmFtZSA9IGRhdGEuc2xpY2UoMiwgdWxlbiArIDIpLnRvU3RyaW5nKCdhc2NpaScpO1xuICBjb25zdCBwbGVuU3RhcnQgPSB1bGVuICsgMjtcbiAgY29uc3QgcGxlbiA9IGRhdGFbcGxlblN0YXJ0XTtcbiAgY29uc3QgcGFzc3dvcmQgPSBkYXRhLnNsaWNlKHBsZW5TdGFydCArIDEsIHBsZW5TdGFydCArIDEgKyBwbGVuKS50b1N0cmluZygnYXNjaWknKTtcblxuICByZXR1cm4geyB1c2VybmFtZSwgcGFzc3dvcmQgfTtcbn1cblxuZnVuY3Rpb24gcmVzcG9uc2VBdXRoKHN1Y2Nlc3MsIGNvbm5lY3Rpb24pIHtcbiAgY29uc3QgYnVmID0gbmV3IEJ1ZmZlcigyKTtcbiAgY29uc3QgdG9Xcml0ZSA9IHN1Y2Nlc3MgPyAweDAxMDAgOiAweDAxMDE7XG4gIGNvbnN0IG5leHRQcm9jZWR1cmUgPSBzdWNjZXNzID8gMiA6IC0xO1xuXG4gIGJ1Zi53cml0ZVVJbnQxNkJFKHRvV3JpdGUpO1xuICBjb25uZWN0aW9uLndyaXRlKGJ1Zik7XG4gIGNvbm5lY3Rpb24uZW5kKCk7XG5cbiAgcmV0dXJuIG5leHRQcm9jZWR1cmU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1c2VybmFtZVBhc3N3b3JkQXV0aGV0aWNhdGlvbihjb25uZWN0aW9uLCBkYXRhLCBhdXRoSW5mbykge1xuICAvLyArLS0tLSstLS0tLS0rLS0tLS0tLS0tLSstLS0tLS0rLS0tLS0tLS0tLStcbiAgLy8gfFZFUiB8IFVMRU4gfCAgVU5BTUUgICB8IFBMRU4gfCAgUEFTU1dEICB8XG4gIC8vICstLS0tKy0tLS0tLSstLS0tLS0tLS0tKy0tLS0tLSstLS0tLS0tLS0tK1xuICAvLyB8IDEgIHwgIDEgICB8IDEgdG8gMjU1IHwgIDEgICB8IDEgdG8gMjU1IHxcbiAgLy8gKy0tLS0rLS0tLS0tKy0tLS0tLS0tLS0rLS0tLS0tKy0tLS0tLS0tLS0rXG5cbiAgY29uc3QgdXNlcm5hbWVQYXNzd29yZCA9IGZldGNoVXNlcm5hbWVQYXNzd29yZChkYXRhKTtcblxuICBpZiAoIXVzZXJuYW1lUGFzc3dvcmQpIHtcbiAgICByZXR1cm4gcmVzcG9uc2VBdXRoKGZhbHNlLCBjb25uZWN0aW9uKTtcbiAgfVxuXG4gIGNvbnN0IHsgdXNlcm5hbWUsIHBhc3N3b3JkIH0gPSB1c2VybmFtZVBhc3N3b3JkO1xuXG4gIGlmICghdmFsaWRhdGUoYXV0aEluZm8sIHVzZXJuYW1lLCBwYXNzd29yZCkpIHtcbiAgICByZXR1cm4gcmVzcG9uc2VBdXRoKGZhbHNlLCBjb25uZWN0aW9uKTtcbiAgfVxuXG4gIHJldHVybiByZXNwb25zZUF1dGgodHJ1ZSwgY29ubmVjdGlvbik7XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVJlcXVlc3QoXG4gIGNvbm5lY3Rpb24sIGRhdGEsXG4gIHsgc2VydmVyQWRkciwgc2VydmVyUG9ydCwgcGFzc3dvcmQsIG1ldGhvZCwgbG9jYWxBZGRyLCBsb2NhbFBvcnQsXG4gICAgbG9jYWxBZGRySVB2NiB9LFxuICBkc3RJbmZvLCBvbkNvbm5lY3QsIG9uRGVzdHJveSwgaXNDbGllbnRDb25uZWN0ZWRcbikge1xuICBjb25zdCBjbWQgPSBkYXRhWzFdO1xuICBjb25zdCBjbGllbnRPcHRpb25zID0ge1xuICAgIHBvcnQ6IHNlcnZlclBvcnQsXG4gICAgaG9zdDogc2VydmVyQWRkcixcbiAgfTtcbiAgY29uc3QgaXNVRFBSZWxheSA9IChjbWQgPT09IDB4MDMpO1xuXG4gIGxldCByZXBCdWY7XG4gIGxldCB0bXAgPSBudWxsO1xuICBsZXQgZGVjaXBoZXIgPSBudWxsO1xuICBsZXQgZGVjaXBoZXJlZERhdGEgPSBudWxsO1xuICBsZXQgY2lwaGVyID0gbnVsbDtcbiAgbGV0IGNpcGhlcmVkRGF0YSA9IG51bGw7XG5cbiAgaWYgKGNtZCAhPT0gMHgwMSAmJiAhaXNVRFBSZWxheSkge1xuICAgIGxvZ2dlci53YXJuKGB1bnN1cHBvcnRlZCBjbWQ6ICR7Y21kfWApO1xuICAgIHJldHVybiB7XG4gICAgICBzdGFnZTogLTEsXG4gICAgfTtcbiAgfVxuXG4gIC8vIHByZXBhcmUgZGF0YVxuXG4gIC8vICstLS0tKy0tLS0tKy0tLS0tLS0rLS0tLS0tKy0tLS0tLS0tLS0rLS0tLS0tLS0tLStcbiAgLy8gfFZFUiB8IFJFUCB8ICBSU1YgIHwgQVRZUCB8IEJORC5BRERSIHwgQk5ELlBPUlQgfFxuICAvLyArLS0tLSstLS0tLSstLS0tLS0tKy0tLS0tLSstLS0tLS0tLS0tKy0tLS0tLS0tLS0rXG4gIC8vIHwgMSAgfCAgMSAgfCBYJzAwJyB8ICAxICAgfCBWYXJpYWJsZSB8ICAgIDIgICAgIHxcbiAgLy8gKy0tLS0rLS0tLS0rLS0tLS0tLSstLS0tLS0rLS0tLS0tLS0tLSstLS0tLS0tLS0tK1xuXG4gIGlmIChpc1VEUFJlbGF5KSB7XG4gICAgY29uc3QgaXNVRFA0ID0gZHN0SW5mby5hdHlwID09PSAxO1xuXG4gICAgcmVwQnVmID0gbmV3IEJ1ZmZlcig0KTtcbiAgICByZXBCdWYud3JpdGVVSW50MzJCRShpc1VEUDQgPyAweDA1MDAwMDAxIDogMHgwNTAwMDAwNCk7XG4gICAgdG1wID0gbmV3IEJ1ZmZlcigyKTtcbiAgICB0bXAud3JpdGVVSW50MTZCRShsb2NhbFBvcnQpO1xuICAgIHJlcEJ1ZiA9IEJ1ZmZlci5jb25jYXQoW3JlcEJ1ZiwgaXAudG9CdWZmZXIoaXNVRFA0ID8gbG9jYWxBZGRyIDogbG9jYWxBZGRySVB2NiksIHRtcF0pO1xuXG4gICAgY29ubmVjdGlvbi53cml0ZShyZXBCdWYpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YWdlOiAtMSxcbiAgICB9O1xuICB9XG5cbiAgbG9nZ2VyLnZlcmJvc2UoYGNvbm5lY3Rpbmc6ICR7ZHN0SW5mby5kc3RBZGRyLnRvU3RyaW5nKCd1dGY4Jyl9YFxuICAgICsgYDoke2RzdEluZm8uZHN0UG9ydC5yZWFkVUludDE2QkUoKX1gKTtcblxuICByZXBCdWYgPSBuZXcgQnVmZmVyKDEwKTtcbiAgcmVwQnVmLndyaXRlVUludDMyQkUoMHgwNTAwMDAwMSk7XG4gIHJlcEJ1Zi53cml0ZVVJbnQzMkJFKDB4MDAwMDAwMDAsIDQsIDQpO1xuICByZXBCdWYud3JpdGVVSW50MTZCRSgwLCA4LCAyKTtcblxuICB0bXAgPSBjcmVhdGVDaXBoZXIocGFzc3dvcmQsIG1ldGhvZCxcbiAgICBkYXRhLnNsaWNlKDMpKTsgLy8gc2tpcCBWRVIsIENNRCwgUlNWXG4gIGNpcGhlciA9IHRtcC5jaXBoZXI7XG4gIGNpcGhlcmVkRGF0YSA9IHRtcC5kYXRhO1xuXG4gIC8vIGNvbm5lY3RcbiAgY29uc3QgY2xpZW50VG9SZW1vdGUgPSBjb25uZWN0KGNsaWVudE9wdGlvbnMsICgpID0+IHtcbiAgICBvbkNvbm5lY3QoKTtcbiAgfSk7XG5cbiAgY2xpZW50VG9SZW1vdGUub24oJ2RhdGEnLCAocmVtb3RlRGF0YSkgPT4ge1xuICAgIGlmICghZGVjaXBoZXIpIHtcbiAgICAgIHRtcCA9IGNyZWF0ZURlY2lwaGVyKHBhc3N3b3JkLCBtZXRob2QsIHJlbW90ZURhdGEpO1xuICAgICAgaWYgKCF0bXApIHtcbiAgICAgICAgbG9nZ2VyLndhcm4oYCR7TkFNRX0gZ2V0IGludmFsaWQgbXNnYCk7XG4gICAgICAgIG9uRGVzdHJveSgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBkZWNpcGhlciA9IHRtcC5kZWNpcGhlcjtcbiAgICAgIGRlY2lwaGVyZWREYXRhID0gdG1wLmRhdGE7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlY2lwaGVyZWREYXRhID0gZGVjaXBoZXIudXBkYXRlKHJlbW90ZURhdGEpO1xuICAgIH1cblxuICAgIGlmIChpc0NsaWVudENvbm5lY3RlZCgpKSB7XG4gICAgICB3cml0ZU9yUGF1c2UoY2xpZW50VG9SZW1vdGUsIGNvbm5lY3Rpb24sIGRlY2lwaGVyZWREYXRhKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY2xpZW50VG9SZW1vdGUuZGVzdHJveSgpO1xuICAgIH1cbiAgfSk7XG5cbiAgY2xpZW50VG9SZW1vdGUub24oJ2RyYWluJywgKCkgPT4ge1xuICAgIGNvbm5lY3Rpb24ucmVzdW1lKCk7XG4gIH0pO1xuXG4gIGNsaWVudFRvUmVtb3RlLm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgY29ubmVjdGlvbi5lbmQoKTtcbiAgfSk7XG5cbiAgY2xpZW50VG9SZW1vdGUub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICBsb2dnZXIud2Fybignc3NMb2NhbCBlcnJvciBoYXBwZW5lZCBpbiBjbGllbnRUb1JlbW90ZSB3aGVuJ1xuICAgICAgKyBgIGNvbm5lY3RpbmcgdG8gJHtnZXREc3RTdHIoZHN0SW5mbyl9OiAke2UubWVzc2FnZX1gKTtcblxuICAgIG9uRGVzdHJveSgpO1xuICB9KTtcblxuICBjbGllbnRUb1JlbW90ZS5vbignY2xvc2UnLCAoZSkgPT4ge1xuICAgIGlmIChlKSB7XG4gICAgICBjb25uZWN0aW9uLmRlc3Ryb3koKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29ubmVjdGlvbi5lbmQoKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIHdyaXRlXG4gIGNvbm5lY3Rpb24ud3JpdGUocmVwQnVmKTtcblxuICB3cml0ZU9yUGF1c2UoY29ubmVjdGlvbiwgY2xpZW50VG9SZW1vdGUsIGNpcGhlcmVkRGF0YSk7XG5cbiAgcmV0dXJuIHtcbiAgICBzdGFnZTogMixcbiAgICBjaXBoZXIsXG4gICAgY2xpZW50VG9SZW1vdGUsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGhhbmRsZUNvbm5lY3Rpb24oY29uZmlnLCBjb25uZWN0aW9uKSB7XG4gIGNvbnN0IHsgYXV0aEluZm8gfSA9IGNvbmZpZztcblxuICBsZXQgc3RhZ2UgPSAwO1xuICBsZXQgY2xpZW50VG9SZW1vdGU7XG4gIGxldCB0bXA7XG4gIGxldCBjaXBoZXI7XG4gIGxldCBkc3RJbmZvO1xuICBsZXQgcmVtb3RlQ29ubmVjdGVkID0gZmFsc2U7XG4gIGxldCBjbGllbnRDb25uZWN0ZWQgPSB0cnVlO1xuICBsZXQgdGltZXIgPSBudWxsO1xuXG4gIGNvbm5lY3Rpb24ub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgIHN3aXRjaCAoc3RhZ2UpIHtcbiAgICAgIGNhc2UgMDpcbiAgICAgICAgc3RhZ2UgPSBoYW5kbGVNZXRob2QoY29ubmVjdGlvbiwgZGF0YSwgYXV0aEluZm8pO1xuXG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAxOlxuICAgICAgICBkc3RJbmZvID0gZ2V0RHN0SW5mbyhkYXRhKTtcblxuICAgICAgICBpZiAoIWRzdEluZm8pIHtcbiAgICAgICAgICBsb2dnZXIud2FybihgRmFpbGVkIHRvIGdldCAnZHN0SW5mbycgZnJvbSBwYXJzaW5nIGRhdGE6ICR7ZGF0YX1gKTtcbiAgICAgICAgICBjb25uZWN0aW9uLmRlc3Ryb3koKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICB0bXAgPSBoYW5kbGVSZXF1ZXN0KFxuICAgICAgICAgIGNvbm5lY3Rpb24sIGRhdGEsIGNvbmZpZywgZHN0SW5mbyxcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAvLyBhZnRlciBjb25uZWN0ZWRcbiAgICAgICAgICAgIHJlbW90ZUNvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgICAgfSxcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICAvLyBnZXQgaW52YWxpZCBtc2cgb3IgZXJyIGhhcHBlbmVkXG4gICAgICAgICAgICBpZiAocmVtb3RlQ29ubmVjdGVkKSB7XG4gICAgICAgICAgICAgIHJlbW90ZUNvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgICBjbGllbnRUb1JlbW90ZS5kZXN0cm95KCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjbGllbnRDb25uZWN0ZWQpIHtcbiAgICAgICAgICAgICAgY2xpZW50Q29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgICAgICAgIGNvbm5lY3Rpb24uZGVzdHJveSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAgKCkgPT4gY2xpZW50Q29ubmVjdGVkXG4gICAgICAgICk7XG5cbiAgICAgICAgc3RhZ2UgPSB0bXAuc3RhZ2U7XG5cbiAgICAgICAgaWYgKHN0YWdlID09PSAyKSB7XG4gICAgICAgICAgY2xpZW50VG9SZW1vdGUgPSB0bXAuY2xpZW50VG9SZW1vdGU7XG4gICAgICAgICAgY2lwaGVyID0gdG1wLmNpcGhlcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyB1ZHAgcmVsYXlcbiAgICAgICAgICBjbGllbnRDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgICBjb25uZWN0aW9uLmVuZCgpO1xuICAgICAgICB9XG5cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIDI6XG4gICAgICAgIHRtcCA9IGNpcGhlci51cGRhdGUoZGF0YSk7XG5cbiAgICAgICAgd3JpdGVPclBhdXNlKGNvbm5lY3Rpb24sIGNsaWVudFRvUmVtb3RlLCB0bXApO1xuXG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAzOlxuICAgICAgICAvLyByZmMgMTkyOSB1c2VybmFtZS9wYXNzd29yZCBhdXRoZXRpY2F0aW9uXG4gICAgICAgIHN0YWdlID0gdXNlcm5hbWVQYXNzd29yZEF1dGhldGljYXRpb24oY29ubmVjdGlvbiwgZGF0YSwgYXV0aEluZm8pO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgfVxuICB9KTtcblxuICBjb25uZWN0aW9uLm9uKCdkcmFpbicsICgpID0+IHtcbiAgICBpZiAocmVtb3RlQ29ubmVjdGVkKSB7XG4gICAgICBjbGllbnRUb1JlbW90ZS5yZXN1bWUoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbm5lY3Rpb24ub24oJ2VuZCcsICgpID0+IHtcbiAgICBjbGllbnRDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICBpZiAocmVtb3RlQ29ubmVjdGVkKSB7XG4gICAgICBjbGllbnRUb1JlbW90ZS5lbmQoKTtcbiAgICB9XG4gIH0pO1xuXG4gIGNvbm5lY3Rpb24ub24oJ2Nsb3NlJywgKGUpID0+IHtcbiAgICBpZiAodGltZXIpIHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgfVxuXG4gICAgY2xpZW50Q29ubmVjdGVkID0gZmFsc2U7XG5cbiAgICBpZiAocmVtb3RlQ29ubmVjdGVkKSB7XG4gICAgICBpZiAoZSkge1xuICAgICAgICBjbGllbnRUb1JlbW90ZS5kZXN0cm95KCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjbGllbnRUb1JlbW90ZS5lbmQoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGNvbm5lY3Rpb24ub24oJ2Vycm9yJywgKGUpID0+IHtcbiAgICBsb2dnZXIud2FybihgJHtOQU1FfSBlcnJvciBoYXBwZW5lZCBpbiBjbGllbnQgY29ubmVjdGlvbjogJHtlLm1lc3NhZ2V9YCk7XG4gIH0pO1xuXG4gIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgaWYgKGNsaWVudENvbm5lY3RlZCkge1xuICAgICAgY29ubmVjdGlvbi5kZXN0cm95KCk7XG4gICAgfVxuXG4gICAgaWYgKHJlbW90ZUNvbm5lY3RlZCkge1xuICAgICAgY2xpZW50VG9SZW1vdGUuZGVzdHJveSgpO1xuICAgIH1cbiAgfSwgY29uZmlnLnRpbWVvdXQgKiAxMDAwKTtcbn1cblxuZnVuY3Rpb24gY2xvc2VBbGwoKSB7XG4gIGNsb3NlU2lsZW50bHkodGhpcy5zZXJ2ZXIpO1xuICBjbG9zZVNpbGVudGx5KHRoaXMucGFjU2VydmVyKTtcblxuICB0aGlzLnVkcFJlbGF5LmNsb3NlKCk7XG5cbiAgaWYgKHRoaXMuaHR0cFByb3h5U2VydmVyKSB7XG4gICAgdGhpcy5odHRwUHJveHlTZXJ2ZXIuY2xvc2UoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjcmVhdGVTZXJ2ZXIoY29uZmlnKSB7XG4gIGNvbnN0IHNlcnZlciA9IF9jcmVhdGVTZXJ2ZXIoaGFuZGxlQ29ubmVjdGlvbi5iaW5kKG51bGwsIGNvbmZpZykpO1xuICBjb25zdCB1ZHBSZWxheSA9IGNyZWF0ZVVEUFJlbGF5KGNvbmZpZywgZmFsc2UsIGxvZ2dlcik7XG4gIGNvbnN0IHBhY1NlcnZlciA9IGNyZWF0ZVBBQ1NlcnZlcihjb25maWcsIGxvZ2dlcik7XG5cbiAgc2VydmVyLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICBsb2dnZXIud2FybihgJHtOQU1FfSBzZXJ2ZXIgY2xvc2VkYCk7XG4gIH0pO1xuXG4gIHNlcnZlci5vbignZXJyb3InLCAoZSkgPT4ge1xuICAgIGxvZ2dlci5lcnJvcihgJHtOQU1FfSBzZXJ2ZXIgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9KTtcblxuICBzZXJ2ZXIubGlzdGVuKGNvbmZpZy5sb2NhbFBvcnQpO1xuXG4gIGxvZ2dlci52ZXJib3NlKGAke05BTUV9IGlzIGxpc3RlbmluZyBvbiAke2NvbmZpZy5sb2NhbEFkZHJ9OiR7Y29uZmlnLmxvY2FsUG9ydH1gKTtcblxuICByZXR1cm4ge1xuICAgIHNlcnZlcixcbiAgICB1ZHBSZWxheSxcbiAgICBwYWNTZXJ2ZXIsXG4gICAgY2xvc2VBbGwsXG4gIH07XG59XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZVxuZXhwb3J0IGZ1bmN0aW9uIHN0YXJ0U2VydmVyKGNvbmZpZywgd2lsbExvZ1RvQ29uc29sZSA9IGZhbHNlKSB7XG4gIGxvZ2dlciA9IGxvZ2dlciB8fCBjcmVhdGVMb2dnZXIoY29uZmlnLCBMT0dfTkFNRVMuTE9DQUwsIHdpbGxMb2dUb0NvbnNvbGUpO1xuXG4gIGNvbnN0IHsgaW5mbywgd2FybiwgZXJyb3IgfSA9IGNyZWF0ZUF1dGhJbmZvKGNvbmZpZyk7XG5cbiAgaWYgKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKGAke05BTUV9IGVycm9yOiAke2Vycm9yfWApO1xuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgaWYgKHdhcm4pIHtcbiAgICBsb2dnZXIud2FybihgJHtOQU1FfTogJHt3YXJufWApO1xuICB9XG5cbiAgcmV0dXJuIGNyZWF0ZVNlcnZlcihPYmplY3QuYXNzaWduKHt9LCBjb25maWcsIHtcbiAgICBhdXRoSW5mbzogaW5mbyxcbiAgfSkpO1xufVxuXG5pZiAobW9kdWxlID09PSByZXF1aXJlLm1haW4pIHtcbiAgZ2V0Q29uZmlnKHByb2Nlc3MuYXJndi5zbGljZSgyKSwgKGVyciwgY29uZmlnKSA9PiB7XG4gICAgaWYgKGVycikge1xuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cblxuICAgIGNvbnN0IHsgcHJveHlPcHRpb25zIH0gPSBjb25maWc7XG5cbiAgICBsb2dnZXIgPSBjcmVhdGVMb2dnZXIoXG4gICAgICBwcm94eU9wdGlvbnMsXG4gICAgICBMT0dfTkFNRVMuTE9DQUwsXG4gICAgICB0cnVlLFxuICAgICAgdHJ1ZSxcbiAgICApO1xuICAgIHN0YXJ0U2VydmVyKHByb3h5T3B0aW9ucywgZmFsc2UpO1xuICB9KTtcblxuICBwcm9jZXNzLm9uKCd1bmNhdWdodEV4Y2VwdGlvbicsIChlcnIpID0+IHtcbiAgICBsb2dnZXIuZXJyb3IoYCR7TkFNRX0gdW5jYXVnaHRFeGNlcHRpb246ICR7ZXJyLnN0YWNrfSBgLCBjcmVhdGVTYWZlQWZ0ZXJIYW5kbGVyKGxvZ2dlciwgKCkgPT4ge1xuICAgICAgcHJvY2Vzcy5leGl0KDEpO1xuICAgIH0pKTtcbiAgfSk7XG59XG4iXX0=