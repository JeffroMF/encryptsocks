'use strict';

exports.__esModule = true;
exports.GFWLIST_FILE_PATH = undefined;
exports.readLine = readLine;
exports.createListArrayString = createListArrayString;
exports.createPACFileContent = createPACFileContent;
exports.requestGFWList = requestGFWList;
exports.getPACFileContent = getPACFileContent;
exports.updateGFWList = updateGFWList;

var _path = require('path');

var _https = require('https');

var _http = require('http');

var _url = require('url');

var _fs = require('fs');

var _uglifyJs = require('uglify-js');

// NOTE: do not use these in local server
var GFWLIST_FILE_PATH = exports.GFWLIST_FILE_PATH = (0, _path.join)(__dirname, '../pac/gfwlist.txt');
var DEFAULT_CONFIG = {
  localAddr: '127.0.0.1',
  localPort: '1080'
};
var TARGET_URL = 'https://raw.githubusercontent.com/gfwlist/gfwlist/master/gfwlist.txt';
var LINE_DELIMER = ['\r\n', '\r', '\n'];
var MINIFY_OPTIONS = {
  warnings: false
};

var readLineLastContent = null;
var readLineLastIndex = 0;

function clear() {
  readLineLastContent = null;
  readLineLastIndex = 0;
}

function base64ToString(base64String) {
  return Buffer.from(base64String, 'base64').toString();
}

// function stringToBase64(string) {
// return (new Buffer(base64String, 'base64')).toString('base64');
// }

function readLine(text, shouldStrip) {
  var startIndex = 0;
  var i = null;
  var delimer = null;

  if (text === readLineLastContent) {
    startIndex = readLineLastIndex;
  } else {
    readLineLastContent = text;
  }

  LINE_DELIMER.forEach(function (char) {
    var index = text.indexOf(char, startIndex);

    if (index !== -1 && (i === null || index < i)) {
      i = index;
      delimer = char;
    }
  });

  if (i !== null) {
    readLineLastIndex = i + delimer.length;
    return shouldStrip ? text.slice(startIndex, i) : text.slice(startIndex, readLineLastIndex);
  }

  readLineLastIndex = 0;
  return null;
}

readLine.clear = clear;

function shouldDropLine(line) {
  // NOTE: It's possible that gfwlist has rules that is a too long
  // regexp that may crush proxies like 'SwitchySharp' so we would
  // drop these rules here.
  return !line || line[0] === '!' || line[0] === '[' || line.length > 100;
}

var slashReg = /\//g;

function encode(line) {
  return line.replace(slashReg, '\\/');
}

function createListArrayString(text) {
  var list = [];
  var line = readLine(text, true);

  while (line !== null) {
    if (!shouldDropLine(line)) {
      list.push('"' + encode(line) + '"');
    }

    line = readLine(text, true);
  }

  return 'var rules = [' + list.join(',\n') + '];';
}

function createPACFileContent(text, _ref) {
  var localAddr = _ref.localAddr,
      localPort = _ref.localPort;

  var HOST = localAddr + ':' + localPort;
  var readFileOptions = { encoding: 'utf8' };
  var userRulesString = (0, _fs.readFileSync)((0, _path.join)(__dirname, '../pac/user.txt'), readFileOptions);
  var rulesString = createListArrayString(userRulesString + '\n' + text);
  var SOCKS_STR = 'var proxy = "SOCKS5 ' + HOST + '; SOCKS ' + HOST + '; DIRECT;";';
  var matcherString = (0, _fs.readFileSync)((0, _path.join)(__dirname, '../vendor/ADPMatcher.js'), readFileOptions);

  return SOCKS_STR + '\n' + rulesString + '\n' + matcherString;
}

function requestGFWList(targetURL, next) {
  var options = (0, _url.parse)(targetURL);
  var requestMethod = options.protocol.indexOf('https') >= 0 ? _https.request : _http.request;

  var req = requestMethod(options, function (res) {
    var data = null;

    res.on('data', function (chunk) {
      data = data ? Buffer.concat([data, chunk]) : chunk;
    });

    res.on('end', function () {
      // gfwlist.txt use utf8 encoded content to present base64 content
      var listText = data.toString();
      next(null, listText);
    });
  });

  req.on('error', function (err) {
    next(err);
  });

  req.end();
}

function minifyCode(code) {
  return (0, _uglifyJs.minify)(code, MINIFY_OPTIONS).code;
}

// TODO: async this
function getPACFileContent(_config) {
  var config = _config || DEFAULT_CONFIG;
  var listText = base64ToString((0, _fs.readFileSync)(GFWLIST_FILE_PATH, { encoding: 'utf8' }));

  return minifyCode(createPACFileContent(listText, config));
}

function writeGFWList(listBuffer, next) {
  (0, _fs.writeFile)(GFWLIST_FILE_PATH, listBuffer, next);
}

function updateGFWList() {
  var targetURL = TARGET_URL;
  var next = void 0;

  if (arguments.length === 1) {
    next = arguments.length <= 0 ? undefined : arguments[0];
  } else if (arguments.length === 2) {
    targetURL = arguments.length <= 0 ? undefined : arguments[0];
    next = arguments.length <= 1 ? undefined : arguments[1];
  }

  requestGFWList(targetURL, function (err, listBuffer) {
    if (err) {
      next(err);
      return;
    }

    writeGFWList(listBuffer, next);
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9nZndsaXN0VXRpbHMuanMiXSwibmFtZXMiOlsicmVhZExpbmUiLCJjcmVhdGVMaXN0QXJyYXlTdHJpbmciLCJjcmVhdGVQQUNGaWxlQ29udGVudCIsInJlcXVlc3RHRldMaXN0IiwiZ2V0UEFDRmlsZUNvbnRlbnQiLCJ1cGRhdGVHRldMaXN0IiwiR0ZXTElTVF9GSUxFX1BBVEgiLCJfX2Rpcm5hbWUiLCJERUZBVUxUX0NPTkZJRyIsImxvY2FsQWRkciIsImxvY2FsUG9ydCIsIlRBUkdFVF9VUkwiLCJMSU5FX0RFTElNRVIiLCJNSU5JRllfT1BUSU9OUyIsIndhcm5pbmdzIiwicmVhZExpbmVMYXN0Q29udGVudCIsInJlYWRMaW5lTGFzdEluZGV4IiwiY2xlYXIiLCJiYXNlNjRUb1N0cmluZyIsImJhc2U2NFN0cmluZyIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsInRleHQiLCJzaG91bGRTdHJpcCIsInN0YXJ0SW5kZXgiLCJpIiwiZGVsaW1lciIsImZvckVhY2giLCJjaGFyIiwiaW5kZXgiLCJpbmRleE9mIiwibGVuZ3RoIiwic2xpY2UiLCJzaG91bGREcm9wTGluZSIsImxpbmUiLCJzbGFzaFJlZyIsImVuY29kZSIsInJlcGxhY2UiLCJsaXN0IiwicHVzaCIsImpvaW4iLCJIT1NUIiwicmVhZEZpbGVPcHRpb25zIiwiZW5jb2RpbmciLCJ1c2VyUnVsZXNTdHJpbmciLCJydWxlc1N0cmluZyIsIlNPQ0tTX1NUUiIsIm1hdGNoZXJTdHJpbmciLCJ0YXJnZXRVUkwiLCJuZXh0Iiwib3B0aW9ucyIsInJlcXVlc3RNZXRob2QiLCJwcm90b2NvbCIsInJlcSIsInJlcyIsImRhdGEiLCJvbiIsImNodW5rIiwiY29uY2F0IiwibGlzdFRleHQiLCJlcnIiLCJlbmQiLCJtaW5pZnlDb2RlIiwiY29kZSIsIl9jb25maWciLCJjb25maWciLCJ3cml0ZUdGV0xpc3QiLCJsaXN0QnVmZmVyIl0sIm1hcHBpbmdzIjoiOzs7O1FBbUNnQkEsUSxHQUFBQSxR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QUFKLEVBQVM7QUFDUFgsV0FBS1csR0FBTDtBQUNBO0FBQ0Q7O0FBRURNLGlCQUFhQyxVQUFiLEVBQXlCbEIsSUFBekI7QUFDRCxHQVBEO0FBUUQiLCJmaWxlIjoiZ2Z3bGlzdFV0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gTk9URTogZG8gbm90IHVzZSB0aGVzZSBpbiBsb2NhbCBzZXJ2ZXJcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IHJlcXVlc3QgfSBmcm9tICdodHRwcyc7XG5pbXBvcnQgeyByZXF1ZXN0IGFzIGh0dHBSZXF1ZXN0IH0gZnJvbSAnaHR0cCc7XG5pbXBvcnQgeyBwYXJzZSB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyB3cml0ZUZpbGUsIHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IG1pbmlmeSB9IGZyb20gJ3VnbGlmeS1qcyc7XG5cbmV4cG9ydCBjb25zdCBHRldMSVNUX0ZJTEVfUEFUSCA9IGpvaW4oX19kaXJuYW1lLCAnLi4vcGFjL2dmd2xpc3QudHh0Jyk7XG5jb25zdCBERUZBVUxUX0NPTkZJRyA9IHtcbiAgbG9jYWxBZGRyOiAnMTI3LjAuMC4xJyxcbiAgbG9jYWxQb3J0OiAnMTA4MCcsXG59O1xuY29uc3QgVEFSR0VUX1VSTCA9ICdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vZ2Z3bGlzdC9nZndsaXN0L21hc3Rlci9nZndsaXN0LnR4dCc7XG5jb25zdCBMSU5FX0RFTElNRVIgPSBbJ1xcclxcbicsICdcXHInLCAnXFxuJ107XG5jb25zdCBNSU5JRllfT1BUSU9OUyA9IHtcbiAgd2FybmluZ3M6IGZhbHNlLFxufTtcblxubGV0IHJlYWRMaW5lTGFzdENvbnRlbnQgPSBudWxsO1xubGV0IHJlYWRMaW5lTGFzdEluZGV4ID0gMDtcblxuZnVuY3Rpb24gY2xlYXIoKSB7XG4gIHJlYWRMaW5lTGFzdENvbnRlbnQgPSBudWxsO1xuICByZWFkTGluZUxhc3RJbmRleCA9IDA7XG59XG5cbmZ1bmN0aW9uIGJhc2U2NFRvU3RyaW5nKGJhc2U2NFN0cmluZykge1xuICByZXR1cm4gQnVmZmVyLmZyb20oYmFzZTY0U3RyaW5nLCAnYmFzZTY0JykudG9TdHJpbmcoKTtcbn1cblxuLy8gZnVuY3Rpb24gc3RyaW5nVG9CYXNlNjQoc3RyaW5nKSB7XG4vLyByZXR1cm4gKG5ldyBCdWZmZXIoYmFzZTY0U3RyaW5nLCAnYmFzZTY0JykpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbi8vIH1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRMaW5lKHRleHQsIHNob3VsZFN0cmlwKSB7XG4gIGxldCBzdGFydEluZGV4ID0gMDtcbiAgbGV0IGkgPSBudWxsO1xuICBsZXQgZGVsaW1lciA9IG51bGw7XG5cbiAgaWYgKHRleHQgPT09IHJlYWRMaW5lTGFzdENvbnRlbnQpIHtcbiAgICBzdGFydEluZGV4ID0gcmVhZExpbmVMYXN0SW5kZXg7XG4gIH0gZWxzZSB7XG4gICAgcmVhZExpbmVMYXN0Q29udGVudCA9IHRleHQ7XG4gIH1cblxuICBMSU5FX0RFTElNRVIuZm9yRWFjaCgoY2hhcikgPT4ge1xuICAgIGNvbnN0IGluZGV4ID0gdGV4dC5pbmRleE9mKGNoYXIsIHN0YXJ0SW5kZXgpO1xuXG4gICAgaWYgKGluZGV4ICE9PSAtMSAmJiAoaSA9PT0gbnVsbCB8fCBpbmRleCA8IGkpKSB7XG4gICAgICBpID0gaW5kZXg7XG4gICAgICBkZWxpbWVyID0gY2hhcjtcbiAgICB9XG4gIH0pO1xuXG4gIGlmIChpICE9PSBudWxsKSB7XG4gICAgcmVhZExpbmVMYXN0SW5kZXggPSBpICsgZGVsaW1lci5sZW5ndGg7XG4gICAgcmV0dXJuIHNob3VsZFN0cmlwID8gdGV4dC5zbGljZShzdGFydEluZGV4LCBpKSA6IHRleHQuc2xpY2Uoc3RhcnRJbmRleCwgcmVhZExpbmVMYXN0SW5kZXgpO1xuICB9XG5cbiAgcmVhZExpbmVMYXN0SW5kZXggPSAwO1xuICByZXR1cm4gbnVsbDtcbn1cblxucmVhZExpbmUuY2xlYXIgPSBjbGVhcjtcblxuZnVuY3Rpb24gc2hvdWxkRHJvcExpbmUobGluZSkge1xuICAvLyBOT1RFOiBJdCdzIHBvc3NpYmxlIHRoYXQgZ2Z3bGlzdCBoYXMgcnVsZXMgdGhhdCBpcyBhIHRvbyBsb25nXG4gIC8vIHJlZ2V4cCB0aGF0IG1heSBjcnVzaCBwcm94aWVzIGxpa2UgJ1N3aXRjaHlTaGFycCcgc28gd2Ugd291bGRcbiAgLy8gZHJvcCB0aGVzZSBydWxlcyBoZXJlLlxuICByZXR1cm4gIWxpbmUgfHwgbGluZVswXSA9PT0gJyEnIHx8IGxpbmVbMF0gPT09ICdbJyB8fCBsaW5lLmxlbmd0aCA+IDEwMDtcbn1cblxuY29uc3Qgc2xhc2hSZWcgPSAvXFwvL2c7XG5cbmZ1bmN0aW9uIGVuY29kZShsaW5lKSB7XG4gIHJldHVybiBsaW5lLnJlcGxhY2Uoc2xhc2hSZWcsICdcXFxcLycpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTGlzdEFycmF5U3RyaW5nKHRleHQpIHtcbiAgY29uc3QgbGlzdCA9IFtdO1xuICBsZXQgbGluZSA9IHJlYWRMaW5lKHRleHQsIHRydWUpO1xuXG4gIHdoaWxlIChsaW5lICE9PSBudWxsKSB7XG4gICAgaWYgKCFzaG91bGREcm9wTGluZShsaW5lKSkge1xuICAgICAgbGlzdC5wdXNoKGBcIiR7ZW5jb2RlKGxpbmUpfVwiYCk7XG4gICAgfVxuXG4gICAgbGluZSA9IHJlYWRMaW5lKHRleHQsIHRydWUpO1xuICB9XG5cbiAgcmV0dXJuIGB2YXIgcnVsZXMgPSBbJHtsaXN0LmpvaW4oJyxcXG4nKX1dO2A7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVQQUNGaWxlQ29udGVudCh0ZXh0LCB7IGxvY2FsQWRkciwgbG9jYWxQb3J0IH0pIHtcbiAgY29uc3QgSE9TVCA9IGAke2xvY2FsQWRkcn06JHtsb2NhbFBvcnR9YDtcbiAgY29uc3QgcmVhZEZpbGVPcHRpb25zID0geyBlbmNvZGluZzogJ3V0ZjgnIH07XG4gIGNvbnN0IHVzZXJSdWxlc1N0cmluZyA9IHJlYWRGaWxlU3luYyhqb2luKF9fZGlybmFtZSwgJy4uL3BhYy91c2VyLnR4dCcpLCByZWFkRmlsZU9wdGlvbnMpO1xuICBjb25zdCBydWxlc1N0cmluZyA9IGNyZWF0ZUxpc3RBcnJheVN0cmluZyhgJHt1c2VyUnVsZXNTdHJpbmd9XFxuJHt0ZXh0fWApO1xuICBjb25zdCBTT0NLU19TVFIgPSBgdmFyIHByb3h5ID0gXCJTT0NLUzUgJHtIT1NUfTsgU09DS1MgJHtIT1NUfTsgRElSRUNUO1wiO2A7XG4gIGNvbnN0IG1hdGNoZXJTdHJpbmcgPSByZWFkRmlsZVN5bmMoam9pbihfX2Rpcm5hbWUsICcuLi92ZW5kb3IvQURQTWF0Y2hlci5qcycpLCByZWFkRmlsZU9wdGlvbnMpO1xuXG4gIHJldHVybiBgJHtTT0NLU19TVFJ9XFxuJHtydWxlc1N0cmluZ31cXG4ke21hdGNoZXJTdHJpbmd9YDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlcXVlc3RHRldMaXN0KHRhcmdldFVSTCwgbmV4dCkge1xuICBjb25zdCBvcHRpb25zID0gcGFyc2UodGFyZ2V0VVJMKTtcbiAgY29uc3QgcmVxdWVzdE1ldGhvZCA9IChvcHRpb25zLnByb3RvY29sLmluZGV4T2YoJ2h0dHBzJykgPj0gMCA/IHJlcXVlc3QgOiBodHRwUmVxdWVzdCk7XG5cbiAgY29uc3QgcmVxID0gcmVxdWVzdE1ldGhvZChvcHRpb25zLCAocmVzKSA9PiB7XG4gICAgbGV0IGRhdGEgPSBudWxsO1xuXG4gICAgcmVzLm9uKCdkYXRhJywgKGNodW5rKSA9PiB7XG4gICAgICBkYXRhID0gZGF0YSA/IEJ1ZmZlci5jb25jYXQoW2RhdGEsIGNodW5rXSkgOiBjaHVuaztcbiAgICB9KTtcblxuICAgIHJlcy5vbignZW5kJywgKCkgPT4ge1xuICAgICAgLy8gZ2Z3bGlzdC50eHQgdXNlIHV0ZjggZW5jb2RlZCBjb250ZW50IHRvIHByZXNlbnQgYmFzZTY0IGNvbnRlbnRcbiAgICAgIGNvbnN0IGxpc3RUZXh0ID0gZGF0YS50b1N0cmluZygpO1xuICAgICAgbmV4dChudWxsLCBsaXN0VGV4dCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIHJlcS5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgbmV4dChlcnIpO1xuICB9KTtcblxuICByZXEuZW5kKCk7XG59XG5cbmZ1bmN0aW9uIG1pbmlmeUNvZGUoY29kZSkge1xuICByZXR1cm4gbWluaWZ5KGNvZGUsIE1JTklGWV9PUFRJT05TKS5jb2RlO1xufVxuXG4vLyBUT0RPOiBhc3luYyB0aGlzXG5leHBvcnQgZnVuY3Rpb24gZ2V0UEFDRmlsZUNvbnRlbnQoX2NvbmZpZykge1xuICBjb25zdCBjb25maWcgPSBfY29uZmlnIHx8IERFRkFVTFRfQ09ORklHO1xuICBjb25zdCBsaXN0VGV4dCA9IGJhc2U2NFRvU3RyaW5nKHJlYWRGaWxlU3luYyhHRldMSVNUX0ZJTEVfUEFUSCwgeyBlbmNvZGluZzogJ3V0ZjgnIH0pKTtcblxuICByZXR1cm4gbWluaWZ5Q29kZShjcmVhdGVQQUNGaWxlQ29udGVudChsaXN0VGV4dCwgY29uZmlnKSk7XG59XG5cbmZ1bmN0aW9uIHdyaXRlR0ZXTGlzdChsaXN0QnVmZmVyLCBuZXh0KSB7XG4gIHdyaXRlRmlsZShHRldMSVNUX0ZJTEVfUEFUSCwgbGlzdEJ1ZmZlciwgbmV4dCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVHRldMaXN0KC4uLmFyZ3MpIHtcbiAgbGV0IHRhcmdldFVSTCA9IFRBUkdFVF9VUkw7XG4gIGxldCBuZXh0O1xuXG4gIGlmIChhcmdzLmxlbmd0aCA9PT0gMSkge1xuICAgIG5leHQgPSBhcmdzWzBdO1xuICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoID09PSAyKSB7XG4gICAgdGFyZ2V0VVJMID0gYXJnc1swXTtcbiAgICBuZXh0ID0gYXJnc1sxXTtcbiAgfVxuXG4gIHJlcXVlc3RHRldMaXN0KHRhcmdldFVSTCwgKGVyciwgbGlzdEJ1ZmZlcikgPT4ge1xuICAgIGlmIChlcnIpIHtcbiAgICAgIG5leHQoZXJyKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB3cml0ZUdGV0xpc3QobGlzdEJ1ZmZlciwgbmV4dCk7XG4gIH0pO1xufVxuIl19